<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Teleworks MiniPop</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <script>
        document.onreadystatechange = (event) => {
            if (document.readyState == "complete") {
                document.getElementById("close-icon").addEventListener("click", toggleHistory)
            }
        };

        window.electron.receive("history-data", (lookups, fieldsToDisplay = []) => {  
          refresh(lookups, fieldsToDisplay)
        });

        function toggleHistory() {
            window.electron.send("toggle-history");
        }

        function refresh(lookups, fieldsToDisplay) {
          try {
            let lookupCards = document.getElementById("lookup-cards")
            lookupCards.innerHTML = "";
            if(lookups.length > 0) {
              for (let lookup of lookups) {
                let card = generateCard(lookup, fieldsToDisplay)
                lookupCards.appendChild(card)
              }
            }
            } catch (err) {
                // disregard errors
                console.log(err)
            }
        }

        function generateCard(lookup, fieldsToDisplay) {
            try {
              let lookupCard = document.createElement("div");
              lookupCard.classList.add("lookup-card")
              let results = lookup?.results || []

              // crm icon
              if(lookup?.crm) {
                  let iconRow = document.createElement("div")
                  iconRow.classList.add("crm-icon-row", "center")
                  
                  let iconImg = document.createElement("img")
                  iconImg.classList.add("crm-icon")
                  iconImg.src = `build/${lookup.crm.toLowerCase()}-icon-small.png`
                  iconImg.alt = `${lookup.crm} CRM`

                  iconRow.appendChild(iconImg)
                  lookupCard.appendChild(iconRow)
              }

              // details message
              if(lookup?.details || lookup?.input){
                  let detailsRow = document.createElement("div")
                  detailsRow.classList.add("details-row", "center")

                  if(lookup?.details){
                      let detailsSpan = document.createElement("span")
                      detailsSpan.innerHTML = lookup.details
                      detailsSpan.classList.add("details",results.length === 1 ? "orange" : "red")
                      detailsRow.appendChild(detailsSpan)
                  }

                  if(lookup?.input) {
                      let lookupBySpan = document.createElement("span")
                      lookupBySpan.innerHTML = lookup.input
                      lookupBySpan.classList.add("lookup-by")
                      detailsRow.appendChild(lookupBySpan)
                  }

                  lookupCard.appendChild(detailsRow)
              }

              // contact names and details
              if(results.length > 0){
                  let contactNamesDiv = document.createElement("div")
                  contactNamesDiv.classList.add("contact-names-col","scroll-enabled")

                  let contactDetailsDiv = document.createElement("div")
                  contactDetailsDiv.classList.add("contact-details-col","scroll-enabled")

                  // Redtail fields
                  contactDetailsDiv.appendChild(makeField("Status: ","redtail-status"))
                  contactDetailsDiv.appendChild(makeField("Source: ","redtail-source"))
                  contactDetailsDiv.appendChild(makeField("Category: ","redtail-category"))
                  contactDetailsDiv.appendChild(makeField("Client Since: ","redtail-client-since"))

                  for (const [index, contact] of results.entries()) {
                      let nameSpan = document.createElement("span")
                      if(index === 0) {
                          nameSpan.classList.add("contact-name-active")
                          setFields(lookup?.crm, contact, contactDetailsDiv)
                      } else {
                          nameSpan.classList.add("contact-name-inactive")
                      }
                      if(lookup?.crm === "Redtail") {
                          nameSpan.innerHTML = contact?.full_name || "<MISSING>"
                      }
                      nameSpan.addEventListener("click", (e)=>{changeContact(e, lookup?.crm, contact, contactNamesDiv, contactDetailsDiv)})
                      contactNamesDiv.appendChild(nameSpan)
                  }
                  displayFields(fieldsToDisplay, contactDetailsDiv)
                  lookupCard.appendChild(contactNamesDiv)
                  lookupCard.appendChild(contactDetailsDiv)
              }

              // timestamp
              if (lookup?.timestamp){
                  let timestampRow = document.createElement("div")
                  timestampRow.classList.add("timestamp-row", "center")
                  let timestampSpan = document.createElement("span")
                  timestampSpan.classList.add("timestamp")
                  let formattedDate = new Date(lookup.timestamp).toLocaleString()
                  timestampSpan.innerHTML = "Received " + formattedDate;

                  timestampRow.appendChild(timestampSpan)
                  lookupCard.appendChild(timestampRow)
              }
              return lookupCard              
          } catch (err) {
              // disregard errors
              console.log(err)
          }
        }

        function makeField(labelText, className){
            let labelH1 = document.createElement("h1")
            labelH1.classList.add("field")
            labelH1.innerHTML = labelText + "<span class='" + className + "'></span>"
            return labelH1
        }

        function setFields(crm, contact, detailsDiv) {
            try {
                let fields = detailsDiv.getElementsByTagName("span");
                if(fields.length > 0) {
                    for(let field of fields){
                        field.innerHTML = "";
                    }
                    for (let field of fields){
                        if(crm === "Redtail") {
                            if(field.classList.contains("redtail-status")) { field.innerHTML = contact?.status || "<Missing>"; }
                            if(field.classList.contains("redtail-source")) { field.innerHTML = contact?.source || "<Missing>"; }
                            if(field.classList.contains("redtail-category")) { field.innerHTML = contact?.category || "<Missing>"; }
                            if(field.classList.contains("redtail-client-since")) { field.innerHTML = contact?.client_since || "<Missing>"; }
                        }
                    }
                
                }
                
            } catch (err) {
                console.log(err)
            }
        }

        // display fields specified in user settings, hide all others
        function displayFields(fieldsToDisplay, detailsDiv){
            try {
                let labels = detailsDiv.getElementsByTagName("h1");
                if(labels.length > 0) {
                    for(let label of labels){
                        let spans = label.getElementsByTagName("span");
                        if(spans.length > 0){
                            let isWhitelisted = false
                            for (let f of fieldsToDisplay){
                                if(spans[0].classList.contains(f)){
                                    isWhitelisted = true
                                }
                            }
                            if(isWhitelisted){
                                label.classList.remove("hidden")
                            } else {
                                label.classList.add("hidden")
                            }
                        }
                    }
                }
            } catch (err) {
                console.log(err)
            }
        }

        function changeContact (event, crm, contact, namesDiv, detailsDiv) {
            let contacts = namesDiv.getElementsByTagName("span");
            if (contacts?.length > 0 ) {
                for(let c of contacts){
                    c.classList.remove("contact-name-active")
                    c.classList.remove("contact-name-inactive")
                    c.classList.add("contact-name-inactive")
                }
            }
            if(event?.target){
                event.target.classList.remove("contact-name-inactive")
                event.target.classList.add("contact-name-active")
            }
            setFields(crm, contact, detailsDiv)
        }
    </script>

    <header id="titlebar">
        <div id="drag-region">
            <div id="titlebar-left">
                <img id="app-icon" src="build/icon.png" alt="Teleworks"/>
                <span id="app-name">MINIP<span class="orange">O</span>P</span>
            </div>
            <div id="titlebar-center">
                <span id="window-name">CALL HISTORY</span>
            </div>
            <div id="titlebar-right-one">
                <div class="title-button">
                    <img  id="close-icon" src="build/close.svg" alt="Close to tray"/>
                </div>
            </div>
        </div>
    </header>
    <div id="lookup-cards" class="scroll-enabled"></div>
</body>
</html>